<!DOCTYPE html>

<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Loja </title>
    <link rel="stylesheet" href="{static}assets/css/materialize.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{static}assets/css/lojavirtual.css">
</head>

<header class="navbar-fixed">

  <nav class="blue-grey darken-2">

       <div class="navbar-wrapper">
       <!-- Logo -->
        <a href="inicial" class="brand-logo"><img src="{static}assets/images/uwtrans1.png" class="left mini-logo"></img></a>

        <ul class="right hide-on-med-and-down">
        <li><a href="#modalcar">Carrinho<i class="material-icons left">shopping_cart</i></a></li>


        <li><a href="usuario">Ver Perfil<i class="material-icons left">perm_identity</i></a></li>

        <li><a id="logout">Sair<i class="material-icons left">input</i></a></li>

        </ul>

        <div class="nav-wrapper">
        <form>
        <div class="input-field">
          <input id="search" type="search" required>
          <label class="label-icon" for="search"><i class="material-icons">search</i></label>
          <i class="material-icons">close</i>
        </div>
        </form>
        </div>
        </div>


  </nav>

</header>

      <div class="row">
      <div class="col s12 m4 l3">

      <!--MODAL DO PERFIL DE USUARIO-->
      <div class="row">


      <div class="container">
      <!-- INFORMAÇÕES DO USUARIO-->
      <ul class="collection">
      <li class="collection-item avatar">
      <i class="material-icons circle">perm_identity</i>
      <span id="nomeusuario" class="title">Cliente</span>
      <a href="#!" class="secondary-content"><i class="material-icons">grade</i></a>
      </li>
      </ul>

      <!-- SALDO -->
      <div class="botao-sup">

      <div class="col s6"><input id="saldo" type="submit" name="submit" value="" style="font-size: 25px" class="btn-conFace"></div>

      </div>

      <div class="menu">
      <!--MENU DE REDIRECIONAMETO-->
      <div class="input-field col s12" id="category">
        <select id="categoria_produto" class="selection">
            <option value="" disabled selected>Categoria</option>
        </select>
      </div>

      <!--<div class="input-field col s12">
        <select idclass="selection">
            <option value="" disabled selected>Localização</option>
            <option value="1">ICC Norte</option>
            <option value="2">ICC Sul</option>
            <option value="3">Amarelinho BSAN</option>
        </select>
      </div>-->

      <!-- MENU PRINCIPAL-->
      <div class="input-field col s12">
        <select  onchange="filtrar()" id="nome_empresa" class="selection">
            <option  value="0">Empresa</option>
        </select>

      </div>

    <div class="input-field col s12">
        <select onchange="filtrar()" id="intervalo_preco" class="selection">
            <option value='{"price":0, "from":0}'>Preço</option>
            <option value='{"price":0, "from":5}'>R$0,01 - R$5,00</option>
            <option value='{"price":5, "from":10}'>R$5,01 - R$10,00</option>
            <option value='{"price":10, "from":20}'>R$10,00 - R$20,00</option>
            <option value='{"price":20, "from":1000}'>R$20,00 ou mais</option>
        </select>
      </div>

    </div>
    </div>
    </div>
    </div>

      <div class="col s12 m8 l9">
<!--
      <ul class="collapsible" data-collapsible="accordion">
      <li>
        <div class="collapsible-header"><i class="material-icons">shopping_cart</i>Carrinho de Compras</  div>
      <div class="collapsible-body"><span>

      <table class="centered">

        <thead>

          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Preço</th>
          </tr>

        </thead>

        <tbody >
  -->
          <!-- ANTIGO CARRINHO -->
  <!--
          <tr>
            <td>Coxinha (Loja do zé)</td>
            <td>
              <select class="input-field col s4 offset-s4">
                <option value="" disabled selected>Quantidade</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select></td>
            <td>$ 300UniCoins</td>

          </tr>

          <tr>
            <td>coxinha</td>
            <td>
              <select class="input-field col s4 offset-s4">
                <option value="" disabled selected>Quantidade</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select></td>
            <td>TOTAL</td>

          </tr>
  -->
  <!--
        </tbody>
        </table>

      <div class="col s6 offset-s4"><input type="submit" name="submit" value="Finalizar Compra" class="btn-conFace" onclick="finish_purchase()">
      <button class = "btn-conFace" onclick="reset_cart()">Limpar Carrinho</button></div>
      </span>
      </li>
    </ul>
  -->


    <div class="row" id="margem">
    <!-- TABELA DE ITENS -->
    <!--
          ####EXEMPLOS####

    <div class="col s3">
      <div class="card small">
        <div class="card-image">
          <img src="{static}assets/images/coxinha.jpg">
        </div>
        <div class="card-content">
          <p>Recheio de frango com catupiry</p>
          <p>R$3,00</p>
          <p>Zé da Coxinha - ICC Norte</p>
          <a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">add</i></a>
        </div>
      </div>
    </div>

    <div class="col s3">
      <div class="card small">
        <div class="card-image">
          <img src="{static}assets/images/doce.jpg">
        </div>
        <div class="card-content">
          <p>Diversos</p>
          <p>R$1,50</p>
          <p>Só Doces - RU</p>
          <a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">add</i></a>
        </div>
      </div>
    </div>

    <div class="col s3">
      <div class="card small">
        <div class="card-image">
          <img src="{static}assets/images/marmitas.jpg">
        </div>
        <div class="card-content">
          <p>Várias combinações</p>
          <p>R$8,00</p1>
          <p>Maria da Marmita - FT</p>
          <a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">add</i></a>
        </div>
      </div>
    </div>


    <div class="col s3">
      <div class="card small">
        <div class="card-image">
          <img src="{static}assets/images/coxinha.jpg">
        </div>
        <div class="card-content">
          <p>Recheio de frango com catupiry</p>
          <p>R$3,00</p>
          <p>Zé da Coxinha - ICC Norte</p>
          <button>Comprar</button>
        </div>
      </div>
    </div>
    -->
</div>

</div>


<!-- MODAL PARA O CARRINHO-->
<div id="modalcar" class="modal">
      <div class="modal-content">
          <h4>Carrinho de Compras</h4>

      <!-- INFORMAÇÕES DE EXTRATO E CONVERSOR-->
      <ul class="collapsible popout" data-collapsible="accordion">

      <li>
        <div class="collapsible-header"><i class="material-icons">shop</i>Carrinho</div>
        <div class="collapsible-body">

        <span>

        <!-- É AQUI QUE DEVE TER O NOVO CARRINHO-->
        <table class="centered">

        <thead>

          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Preço</th>
          </tr>

        </thead>

        <tbody id="corpo">

          <tr>
            <td>Coxinha zoada (Loja do zé)</td>
            <td>
              <select class="input-field col s4 offset-s4">
                <option value="" disabled selected>Quantidade</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select></td>
            <td>$ 300UniCoins</td>

          </tr>

          <tr>
            <td>coxinha</td>
            <td>
              <select class="input-field col s4 offset-s4">
                <option value="" disabled selected>Quantidade</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select></td>
            <td>TOTAL</td>

          </tr>

        </tbody>
        </table>

         <div class="col s6 offset-s4"><input type="submit" name="submit" value="Finalizar Compra" class="btn-conFace1" onclick="finish_purchase()">

        <button class = "btn-conFace1" onclick="reset_cart()">Limpar Carrinho</button></div>

        </span>
      </li>

      </ul>

      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Fechar</a>
      </div>
</div>

<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/js/materialize.min.js"></script>
<!--Banco de funções de JS criadas pelo back-end -->
<script src="{static}assets/js/uniwallet-backend-api.js"></script>

<script type="text/javascript">

//Para deslogar da tela
    document.getElementById("logout").addEventListener("click",function(){
     Auth.signOut()
     Page.redirect("inicial") 
})

 /* */
check_cart()

load_card()



function check_cart(){
  if (sessionStorage.getItem('carrinho') == null){ /* CONFERE SE JÁ EXISTE CARRINHO NO 'SESSIOSTORAGE' */
    var carrinho = []

    console.log('TA VAZIO')
    sessionStorage.setItem('carrinho', JSON.stringify(carrinho))
  }
}



function filtrar(){
  
  var dicionario = JSON.parse(document.getElementById("intervalo_preco").value)
  var price = dicionario['price']
  var to = dicionario['from']
  var company = document.getElementById("nome_empresa").value
  var data_model = '{"company":x, "price":w, "to":z}'
  var data = data_model.replace("x", company).replace("w", price).replace("z", to)
  
  Request.send(JSON.parse(data), "product/show_x", "POST", function(response){
    
    lista_produtos(response)


  })

   
  



  /*
  var valor = JSON.parse(value)
  
  alert("Teste -" + valor['from']) */
}



function load_card(){
  document.getElementById("corpo").innerHTML = " "
  var datas = JSON.parse(sessionStorage.getItem('carrinho'))
  for (var i = datas.length - 1; i >= 0; i--) { /* CARREGA O CARRINHO COM O SESSIONSTORAGE */

    card(datas[i].nome , datas[i].price, datas[i].quantidade, i)

  }
}


function cart(id, quant, price, nome){
  console.log(nome)
  var carrinho = []
  carrinho = JSON.parse(sessionStorage.getItem('carrinho'))
  /* CARREA O SESSIONSTORAGE COMO A VARIAVEL "carrinho" */

  console.log(id)
  var list = {id: id, quantidade: quant, price: price, nome: nome}
  console.log(list)
  carrinho.push(list)
  /* CRIA UM DICIONARIO COM OS PARAMETROS E ADICIONA NA ARRAY "carrinho" */


  sessionStorage.setItem('carrinho', JSON.stringify(carrinho))
  console.log(sessionStorage.getItem('carrinho'))
  /* ALTERA O SESSIONSTORAGE COM O NOVO 'carrinho' */

  load_card()



  /* ULTILIZA A FUNÇAO "JSON.parse()" PARA TRANSFORMAR A INFORMAÇAO EM UM OBJETO DO JAVASCRIPT
     E A FUNÇAO "JSON.stringify()" PARA TRANFORMAR UM OBJETO JAVASCRIPT EM UMA STRING */

}

function card(productname, productprice, productquantity, cardid){

  var modelo_carrinho = "<tr>\
                          <td>produto</td>\
                          <td>quantidade</td>\
                          <td>$ price UniCoins</td>\
                          <td> <button onclick=\"remove_item(ids)\">Remover</button> </td>\
                        </tr>\  "

  var gold = modelo_carrinho.replace("produto", productname)
  var gold2 = gold.replace("price", productprice)
  var gold3 = gold2.replace("quantidade", productquantity)
  var gold4 = gold3.replace("ids", cardid)

  $("#corpo").append(gold4);
  console.log(document.getElementById("corpo"))
  /* SUBSTITUI O MODELO COM OS PARAMETROS E CONCATENA COM A ÁREA ESPECIFICA DA PAGINA */


}



function finish_purchase(){ /* FINALIZA A COMPRA */
  var products = []
  var teste = JSON.parse(sessionStorage.getItem('carrinho'))

  if (teste.length == 0){
    alert("Seu carrinho está vazio")
  }

  else{

    for (var i = teste.length - 1; i >= 0; i--) { /* CARREGA O CARRINHO COM O SESSIONSTORAGE */
      var list = {id: teste[i].id, quantity: Number(teste[i].quantidade)}
      products.push(list)
    }

    var objeto = {products: products}
    console.log(JSON.stringify(objeto))
    var r = confirm("Tem certeza que deseja Finalizar sua Compra?");
      if (r == true) {
        Request.send(objeto, "purchase/create", "POST", function(response){
          if(alert(JSON.stringify(response.content))){}

          else {
            if (response.code == 200) {
              window.location.reload()
              sessionStorage.removeItem("carrinho")
            }

            else{}
          }

        })
      }
      else {}
  }
}

function reset_cart(){
  sessionStorage.removeItem("carrinho")
  check_cart()
  load_card()
}

function remove_item(id){

  var datas = JSON.parse(sessionStorage.getItem('carrinho'))
  datas.splice(id, 1)
  sessionStorage.setItem('carrinho', JSON.stringify(datas))

  load_card()


}



</script>

<script>
    $(document).ready(function(){
      // the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
      $('.modal').modal();
      });
  </script>


  <script>
    $(function(){
        $(".button-collapse").sideNav();
      });
    </script>

<script type="text/javascript">

balance()

show_filter()

var selectcounter = 0 /* Necessario para gerar id no catalogo */


function lista_produtos(all){
  

    var pagina = ""
    for (var i = all.content.length - 1; i >= 0; i--) {
      /* PREECHE O MODELO COM AS INFORMAÇOES DE CADA PRODUTO E CONCATENA DENTRO DE "pagina" */

      var nome = all.content[i].name
      var price = all.content[i].price
      var company = all.content[i].company_name
      var id = all.content[i].id
      var replace = modelo_produto.replace("nome", nome)
      var replace2 = replace.replace("price", price)
      var replace3 = replace2.replace("company", company)
      var replace4 = replace3.replace("productid", id)
      var replace5 = replace4.replace("productprice", price)
      var replace6 = replace5.replace("productquantity", price)
      var replace7 = replace6.replace("selectid", selectcounter)
      var replace8 = replace7.replace("idvalue", selectcounter)
      var replace9 = replace8.replace("productname", nome)

      selectcounter = selectcounter + 1
      var pagina = pagina.concat(replace9)
      }

    document.getElementById("margem").innerHTML = pagina

    /* ADICIONA A VARIAVEL "pagina" DENTRO DO ELEMENTO */

    $(document).ready(function() {
        $('select').material_select();
      });

}

function show_filter(){





    Request.get("category/list", function(l){
      console.log(l)
      var category = document.getElementById("categoria")
      for (var i = 0; i < l.content.length; i++) {
        category.innerHTML += HTML_Factory.make_tag('option', l.content[i].name, {"value": l.content[i].id})
      }

      Request.get("company/list", function(l){

        var lojas = document.getElementById("nome_empresa")
        var model = "filtro( this.value )"
        for (var i = 0; i < l.content.length; i++) {
          var modelo_option = "<option value=\"id\"> nome </option>\ "          
          var replace = modelo_option.replace("id", l.content[i].id)
          var replace2 = replace.replace("nome", l.content[i].name)
          $("#nome_empresa").append(replace2);

          
        }




        $(document).ready(function() {
          $('select').material_select();
        });

      })

   })

}

Request.get("product/show_all" , function(all){
  /* RECEBE OS DADOS DA ROTA SELECIONADA E PASSA COMO PARAMETRO PARA A FUNÇAO */

    lista_produtos(all)


})

function balance(){
  Request.get("wallet/balance",function(balance){
    console.log(balance.content)
    document.getElementById('saldo').value = "Saldo: " + "$" + balance.content
  })


}

function filtro(){

}




var modelo_produto =  " <div class= \"col s3\" > \
                      <div class=\"card\"/> \
                        <div class=\"card-image\"> \
                          <img src=\"{static}assets/images/comidas.jpg\"> \
                        </div> \
                        <div class=\"card-content\"> \
                          <p>nome</p>\
                          <p>$ price UniCoins</p> \
                          <p>company</p> \
                          <select class=\"offset-s4\" id=\"selectid\">\
                              <option value=\"1\">1</option>\
                              <option value=\"2\">2</option>\
                              <option value=\"3\">3</option>\
                              <option value=\"4\">4</option>\
                          </select>\
                          <button onclick=\"cart(productid, document.getElementById(\'idvalue\').value, productprice, \'productname\' ); Materialize.toast(\'Produto adicionado ao carrinho! \', 4000) \" class=\"waves-effect waves-light  orange darken-4 btn\">Comprar</button>\
                        </div> \
                      </div> \
                    </div> \ "


</script>

<script type="text/javascript">

  //Mostrar o nome que está logado
    Request.send('', 'user/current', 'POST', function(server_response){
    console.log(server_response)
    document.getElementById("nomeusuario").innerHTML = server_response.content.name
    })

</script>

<script>

    $(document).ready(function(){
        $('.collapsible').collapsible();
    });

</script>

</body>

</html>
